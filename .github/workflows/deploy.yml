name: Deploy to Selectel

# Запускается при пуше в ветку master
on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Сначала забираем файлы из репозитория
      - uses: actions/checkout@v3

      # Устанавливаем и настраиваем s3cmd для работы с Selectel
      - name: Sync files to Selectel
        env:
          ACCESS_KEY: ${{ secrets.SELECTEL_ACCESS_KEY }}
          SECRET_KEY: ${{ secrets.SELECTEL_SECRET_KEY }}
          BUCKET: ${{ secrets.SELECTEL_BUCKET }}
          REGION: ${{ secrets.SELECTEL_REGION }}
        run: |
          sudo apt-get update
          sudo apt-get install -y s3cmd
          
          # Синхронизация файлов в бакет
          s3cmd --access_key=$ACCESS_KEY --secret_key=$SECRET_KEY \
                --host=storage.selcdn.ru --host-bucket="%s.storage.selcdn.ru" \
                sync ./ s3://$BUCKET/ --delete-removed
